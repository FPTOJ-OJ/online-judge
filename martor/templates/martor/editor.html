{% load i18n %}
<script id="CKEDITOR_Script">
if (!window.__CKEDITOR_LOADED__) {
    window.__CKEDITOR_LOADED__ = true;

    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
        });
    }

    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdn.ckeditor.com/ckeditor5/46.1.1/ckeditor5.css';
    document.head.appendChild(link);

    async function loadMarkdownIt() {
        const { default: markdownIt } = await import('https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/+esm');
        return markdownIt;
    }

    function getCookie(name) {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            const trimmed = cookie.trim();
            if (trimmed.startsWith(name + "=")) {
                return decodeURIComponent(trimmed.substring(name.length + 1));
            }
        }
        return null;
    }

    async function previewProblem(content) {
        const response = await fetch("/widgets/preview/problem", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                content: content,
                csrfmiddlewaretoken: getCookie("csrftoken")
            })
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return await response.text();
    }

    function attachPreviewLogic(fieldName) {
        const textarea = document.getElementById(`id_${fieldName}`);
        const editorSwitch = document.getElementById(`editor-switch-${fieldName}`);
        $(`#ckeditor-container-${fieldName} .tab-ckeditor-menu .item`).tab({
            onVisible: async function(tabPath) {
                const currentTabPath = this.dataset.tab;
                if (currentTabPath === `ckeditor-preview-tab-${fieldName}`) {
                    const previewBox = this;
                    if (!previewBox) return;
                    let previewContent = '';
                    const ta = document.querySelector(`textarea[name="${fieldName}"]`);
                    previewContent = (ta ? ta.value : '');

                    if (!previewContent.trim()) {
                        previewBox.innerHTML = '<p>{% trans "Nothing to preview" %}</p>';
                        return;
                    }

                    try {
                        const html = await previewProblem(previewContent);
                        previewBox.innerHTML = html;
                        if (window.MathJax) {
                            MathJax.typesetPromise([previewBox]);
                        }
                    } catch (err) {
                        console.error("Preview fetch failed:", err);
                        previewBox.innerHTML = '<p style="color:red">Error loading preview</p>';
                    }
                }
            }
        });

        if (textarea && editorSwitch) {
            const content = textarea.value.trim();
            if (content.startsWith('<htmlrender>')) {
                editorSwitch.value = 'ckeditor';
                switchEditor(editorSwitch, fieldName);
            }
        }
    }

    function initAllEditors() {
        document.querySelectorAll('.main-martor[data-field-name]').forEach(container => {
            const fieldName = container.dataset.fieldName;
            attachPreviewLogic(fieldName);
        });
    }

    function observeNewEditors() {
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === 1 && node.classList.contains('main-martor')) {
                        const fieldName = node.dataset.fieldName;
                        if (fieldName) attachPreviewLogic(fieldName);
                    }
                });
            });
        });
        observer.observe(document.body, { childList: true, subtree: true });
    }

    loadMarkdownIt().then(markdownIt => {
        window.__markdownItInstance__ = markdownIt({
            html: true,
            linkify: true,
            typographer: true
        });

        loadScript('https://cdn.ckeditor.com/ckeditor5/46.1.1/ckeditor5.umd.js')
            .then(() => loadScript('/static/martor/js/editor-switch.js'))
            .then(() => loadScript('https://unpkg.com/mathlive@0.107.0/mathlive.min.js'))
            .then(() => loadScript('/static/martor/js/sidebar-math.js'))
            .then(() => {
                initAllEditors();
                observeNewEditors();
            })
            .catch(err => console.error('Failed to load editor scripts', err));
    });
}
</script>


<div class="main-martor main-martor-{{ field_name }}" data-field-name="{{ field_name }}">
  <div class="section-martor">
    <!-- Toggle Editor -->
    <div class="ui right floated item editor-toggle">
      <select id="editor-switch-{{ field_name }}" style="margin-bottom: 10px;" onchange="switchEditor(this, '{{ field_name }}')">
        <option value="martor">Martor (Markdown)</option>
        <option value="ckeditor">CKEditor (HTML)</option>
      </select>
    </div>

    <!-- Martor Editor -->
    <div id="martor-container-{{ field_name }}" class="editor-container" style="display: block;">
      <div class="ui top attached tabular pointing secondary menu tab-martor-menu">
        <a class="item active" data-tab="editor-tab-{{ field_name }}"><i class="edit icon"></i> {% trans "Editor" %}</a>
        <a class="item" data-tab="preview-tab-{{ field_name }}"><i class="eye icon"></i>{% trans "Preview" %}</a>
        {% include "martor/toolbar.html" %}
      </div>
      <div class="ui bottom attached tab segment active" data-tab="editor-tab-{{ field_name }}">
        <div class="ui active dimmer upload-progress" style="display:none" data-field-name="{{ field_name }}">
          <div class="ui text loader">{% trans "Uploading... please wait..." %}</div>
        </div>
        <div id="martor-{{ field_name }}" class="martor-field martor-field-{{ field_name }}"></div>
        {{ martor }}
        <i class="angle double down grey icon expand-editor"></i>
      </div>
      <div class="ui bottom attached tab segment martor-preview" data-tab="preview-tab-{{ field_name }}">
        <p>{% trans "Nothing to preview" %}</p>
      </div>
    </div>

    <!-- CKEditor Editor -->
    <div id="ckeditor-container-{{ field_name }}" class="ck-editor editor-container editor-container_classic-editor editor-container_include-style editor-container_include-block-toolbar editor-container_include-fullscreen" style="display: none;">
      <div class="ui top attached tabular pointing secondary menu tab-ckeditor-menu">
        <a class="item active" data-tab="ckeditor-editor-tab-{{ field_name }}"><i class="edit icon"></i> {% trans "Editor" %}</a>
        <a class="item" data-tab="ckeditor-preview-tab-{{ field_name }}"><i class="eye icon"></i> {% trans "Preview" %}</a>
      </div>
      <div class="ui bottom attached tab segment active" data-tab="ckeditor-editor-tab-{{ field_name }}">
        <div class="editor-container__editor"><div id="ckeditor-{{ field_name }}"></div></div>
      </div>
      <div class="ui bottom attached tab segment ckeditor-preview" data-tab="ckeditor-preview-tab-{{ field_name }}">
        <p>{% trans "Nothing to preview" %}</p>
      </div>
    </div>

    {% include 'martor/guide.html' %}
  </div>
</div>